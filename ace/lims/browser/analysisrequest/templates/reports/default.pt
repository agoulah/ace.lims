<!--
     Default Analysis Request results template for Bika LIMS

     All data is available using the analysisrequest dictionary.
     Example for accessing and displaying data:

     <p tal:content="python:analysisrequest['laboratory']['title']"></p>

     or

     <p tal:content="analysisrequest/laboratory/title"></p>

     Take a look to the documentation for more information about
     available data and fields.
     https://github.com/bikalabs/Bika-LIMS/wiki/Creating-new-report-templates

   -->
<tal:report tal:define="analysisrequest python:view.getAnalysisRequest();
                        client          analysisrequest/client;
                        contact         analysisrequest/contact;
                        laboratory      analysisrequest/laboratory;
                        portal          analysisrequest/portal;
                        remarks         analysisrequest/remarks;
                        coanr 		analysisrequest/id;">

  <!--
       Page Header
       A div element with the class "page-header" will be placed on the
       top of the report, within the top margin area. This element
       will be displayed on each page.

       Page numbering
       For the number of page, use the "page-current-num" class.
       For the total count, use the "page-total-count" class.
     -->

    <div id="section-header" class="page-header">
        <div id='lab-logo'>
            <div class="table table_header" >
                <div class="row">
                    <div class="td td_logo">
                        <a tal:attributes="href laboratory/url"> <img tal:attributes="src laboratory/logo"/> </a>
                    </div>
                    <div class="td td_coa"> <h1>CERTIFICATE OF ANALYSIS</h1> </div>
                    <div class="td td_numbering">
                        <div class="page-number">Page <span class="page-current-num"></span> of <span class="page-total-count"></span></div>
                        <p tal:content="string:COA #: ${coanr}"></p>
                    </div> 
                </div>
            </div>
        </div>
    </div>


    <!-- Address and Lab info -->
    <div id="section-info">
        <!-- Start of table -->
        <div class="table table_header" >
            <!-- Start of row -->
            <div class="row">
                <!-- Start of td -->
                <div class="td" style="width: 50%">
                    <!-- Start of table -->
                    <div class="table table_header" >
                        <div class="row">
                          <div class="td label" i18n:translate="">Laboratory License ID</div>
                          <div class="td" tal:content="python:laboratory['lab_license_id']">To be confirmed</div>
                        </div>
                        <div class="row">
                          <div class="td label" i18n:translate="">MME Name</div>
                          <div class="td" tal:content="python:client['name']">To be confirmed</div>
                        </div>
                        <div class="row">
                          <div class="td label" i18n:translate="">MME ID</div>
                          <div class="td" tal:content="python:analysisrequest['mme_id']">To be confirmed</div>
                        </div>
                        <div class="row">
                          <div class="td label" i18n:translate="">State ID</div>
                          <div class="td" tal:content="python:analysisrequest['state_id']">To be confirmed</div>
                        </div>
                        <div class="row">
                          <div class="td label" i18n:translate="">Strain</div>
                          <div class="td" tal:content="analysisrequest/strain"> </div>
                        </div>
                        <div class="row">
                          <div class="td label" i18n:translate="">Batch</div>
                          <div class="td" tal:content="analysisrequest/cultivation_batch"> </div>
                        </div>
                        <div class="row">
                          <div class="td label" i18n:translate="">LOT</div>
                          <div class="td" tal:content="analysisrequest/lot"> </div>
                        </div>
                    </div>
                    <!-- End of table -->
                </div>
                <!-- End of td -->
                <!-- Start of td -->
                <div class="td" style="width: 50%">
                    <!-- Laboratory -->
                    <!-- Start of table -->
                    <div class="table table_header" >
                        <div class="row">
                          <div class="td label" i18n:translate="">Laboratory</div>
                          <div class="td" tal:content="laboratory/title"/>
                        </div>
                        <div class="row">
                          <div class="td label" i18n:translate="">Product</div>
                          <div class="td" tal:content="analysisrequest/product"/>
                        </div>
                        <div class="row">
                          <div class="td label" i18n:translate="">Sampling Date</div>
                          <div class="td" tal:content="analysisrequest/sampling_date"> </div>
                        </div>
                        <div class="row">
                          <div class="td label" i18n:translate="">Received Date</div>
                          <div class="td" tal:content="analysisrequest/date_received"> </div>
                        </div>
                    </div>
                    <!-- End of table -->
                </div>
                <!-- End of td -->
            </div>
            <!-- End of row -->
        </div>
        <!-- End of table -->
    </div>
    <!-- End of section-info -->

    <!-- Alert section (invalidated ar, etc.) -->
    <div id="section-alert" tal:condition="analysisrequest/invalid">
        <h1 i18n:translate="">This Analysis Request has been invalidated due to erroneously published results</h1>
        <tal:invalidreport tal:define="child python:analysisrequest['obj'].getChildAnalysisRequest()"
                           tal:condition="child">
            <span i18n:translate="">This Analysis request has been replaced by</span>&nbsp;
            <a tal:attributes="href child/absolute_url" tal:content="child/id"></a>
        </tal:invalidreport>
    </div>
    <div id="section-alert" tal:condition="python:analysisrequest['prepublish']==True and analysisrequest['invalid']==False">
        <h1 i18n:translate="">Provisional report</h1>
    </div>

    <!-- Results section -->
    <tal:def tal:define="transposed python:view.getARAnaysis(analysisrequest['obj']);
                       cat_titles python:view.sorted_by_sort_key(transposed.keys());">
        <div class="an_table">
            <img class="ar-image" 
                tal:condition="analysisrequest/attachment_src"
                tal:attributes="src analysisrequest/attachment_src"/>
        </div>

        <tal:category tal:repeat="cat_title cat_titles">
            <div class="table an_table">
                <div class="row">
                  <span class="th" tal:content="cat_title"/>
                  <span class="th">Unit</span>
                  <span class="th">Result</span>
                </div>
                <tal:cat_analyses tal:repeat="service_title python:sorted(transposed[cat_title].keys())">
                    <div class="row" tal:condition="python:service_title != '_data'" >
                        <span class="td service_title">
                            <span tal:content="service_title"/>
                            <img tal:attributes='src python:portal["url"]+"/++resource++bika.lims.images/accredited.png";'
                                   tal:condition="python:transposed[cat_title][service_title]['accredited']"
                                   class="accredited-ico"/>
                        </span>
                        <span class="td unit"
                          tal:content="python:transposed[cat_title][service_title]['unit']"></span>
                        <span class="td result"
                          tal:content="structure python:transposed[cat_title][service_title]['ars']"/>
                    </div>
                </tal:cat_analyses>
                <tal:cat_data tal:repeat="data python:sorted(transposed[cat_title].keys())">
                  <div tal:condition="python: data=='_data' and len(transposed[cat_title][data]['footnotes']) > 0"
                      tal:content="python:transposed[cat_title][data]['footnotes']">
                  </div>
                </tal:cat_data>
            </div>
        </tal:category>

    </tal:def>
    <div class="table remarks">
        <div class="row">
            <div class="td" tal:content="structure remarks"> </div>
       </div>
    </div>
    <div class="table remarks">
        <div class="row">
            <div class="td" tal:content="structure remarks"> </div>
       </div>
    </div>
  <div id="section-resultsinterpretation"
       tal:define="ri python:dict([(k,v) for (k,v) in analysisrequest.get('resultsinterpretationdepts',{}).items() if v and v.get('richtext','')]);"
       tal:condition="python: ri">
    <h1 i18n:translate="">Results interpretation</h1>
    <tal:ris repeat="rid python:ri.keys()">
      <h2 tal:content="rid" tal:condition="rid"></h2>
      <div tal:content="structure python:ri.get(rid,{}).get('richtext','')"></div>
      <p>&nbsp;</p>
    </tal:ris>
  </div>
    <div class='first-page-footer' style="height:60px">
        <div class="lab-manager">
            <img class="signature"
                tal:condition="laboratory/signature"
                tal:attributes="src laboratory/signature"/>
            <hr style="width:100%"/>
            <div class="lab-manager-name" tal:content="laboratory/lab_manager"></div>
            <div class="lab-manager-date" tal:content="laboratory/today"></div>
            <div class="lab-manager-terms">
                This signature indicate the above material has been reviewed and verified
            </div>
        </div>
        <table style="width:100%; text-align:center;">
            <tr>
                <td tal:content="laboratory/phone"></td>
                <td id="" tal:content='structure laboratory/address'></td>
                <td>
                  <a tal:content="laboratory/email"
                     tal:attributes="url python:'mailto:%s' % laboratory['email']"></a>
                </td>
            </tr>
        </table>
    </div>

    <div class='page-footer' style="height:20px;">
        <table style="width:100%; text-align:center; padding-top:10%">
            <tr>
                <td tal:content="laboratory/phone"></td>
                <td id="" tal:content='structure laboratory/address'></td>
                <td>
                  <a tal:content="laboratory/email"
                     tal:attributes="url python:'mailto:%s' % laboratory['email']"></a>
                </td>
            </tr>
        </table>
    </div>
</tal:report>
